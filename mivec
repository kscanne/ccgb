#!/bin/bash
LIBEXECPATH=/usr/local/libexec
DATAPATH=/usr/local/share/corpas
MAXHITS=250

# takes a stream of line numbers and for each one
# echoes it, but also prints it's "foil" either with "-b" or without.
doublygood()
{
while read ref
do
	echo "${ref}"
	if echo "${ref}" | egrep -e '-b:' > /dev/null
	then
		echo "${ref}" | sed 's/-b:/:/'	
	else
		echo "${ref}" | sed 's/:/-b:/'	
	fi
done
}

# main filter -- input stream is the list of search terms (one per line)
faigh()
{
 TERMS=`cat`
 REGEXP=`echo "${TERMS}" | tr "\n" "_" | sed 's/_/\\\\\\|/g' | sed 's/^/\\\\\\(/; s/..$/\\\\\\)/'`
 echo "${TERMS}" | ${LIBEXECPATH}/ppfaigh ${DATAPATH}/veicteoir.db | tr " " "\n" | grep '.' | sort | uniq -c | sort -r -n | sed 's/^ *[0-9]* //' | head -n "${MAXHITS}" | doublygood | ${LIBEXECPATH}/ppfaigh ${DATAPATH}/mor.db | sed 's/.*/<tuv xml:lang="en">\n<seg>&<\/seg>\n<\/tuv>/' | sed 'N; N; N; N; N; s/.*/<tu>\n&\n<\/tu>/' | sed '/^<seg>/{s/^<seg> */<seg>/; s/ *<\/seg>$/<\/seg>/}'
# | sed "s/${REGEXP}/<b class=\"gramadoir\">&<\/b>/gI" | sed 's/^/<br>/; s/$/<br><hr>/'
}

echo '<?xml version="1.0"?>'
echo '<!DOCTYPE tmx SYSTEM "http://www.lisa.org/tmx/tmx14.dtd">'
echo '<tmx version="1.4">'
echo '<header creationtool="CCGB" creationtoolversion="0.01" segtype="block" o-tmf="none" adminlang="en-us" srclang="en" datatype="plaintext">'
echo '</header>'
echo '<body>'
${LIBEXECPATH}/commontok | faigh
echo '</body>'
echo '</tmx>'
